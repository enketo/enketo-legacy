/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var gui,DEFAULT_SETTINGS={};$(document).ready(function(){gui=new GUI;gui.init();"undefined"==typeof console&&(console={log:function(){}});"undefined"==typeof window.console.debug&&(console.debug=console.log);"true"!==getGetVariable("debug")&&(window.console.log=function(){},window.console.debug=function(){})});function GUI(){}
GUI.prototype.init=function(){this.nav.setup();this.pages().init();this.setEventHandlers();"function"===typeof this.setCustomEventHandlers&&this.setCustomEventHandlers();$(".dialog [title]").tooltip();Modernizr.borderradius&&(Modernizr.boxshadow&&Modernizr.csstransitions&&Modernizr.opacity)&&$(document).trigger("browsersupport","fancy-visuals");$("footer").detach().appendTo("#container");this.display()};GUI.prototype.setup=function(){$(window).trigger("resize")};
GUI.prototype.setEventHandlers=function(){var c=this;$("#feedback-bar .close").click(function(b){b.preventDefault();c.hideFeedback()});$("#page a.close").click(function(b){b.preventDefault();c.pages().close()});$(document).on("click",'a[href^="#"]:not([href="#"]):not(nav ul li a)',function(b){var c=$(this).attr("href");console.log("captured click to nav page, href="+c);"#"!==c&&(b.preventDefault(),$('nav li a[href="'+c+'"]').click())});$('nav ul li a[href^="#"]').click(function(b){b.preventDefault();
b=$(this).attr("href").substr(1);c.pages().open(b);$(this).closest("li").addClass("active")});$(window).on("onlinestatuschange",function(b,d){c.updateStatus.connection(d)});$(document).on("edit","form.jr",function(b,d){c.updateStatus.edit(d)});$(document).on("browsersupport",function(b,d){c.updateStatus.support(d)});$("#page, #feedback-bar").on("change",function(){c.display()});$("header #status-connection").click(function(b){c.showFeedback($(this).attr("title"));b.stopPropagation()});$(window).resize(function(){$("#container").css("top",
$("header").outerHeight());$("body:not(.no-scroll) #container").height($(window).height()-$("header").outerHeight()-$("#form-controls.bottom").outerHeight())})};
GUI.prototype.nav={setup:function(){$("article.page").each(function(){var c,b="",d;d=$(this).attr("id");c=$(this).attr("data-display")?$(this).attr("data-display"):d;b=$(this).attr("data-title")?$(this).attr("data-title"):d;d=$(this).attr("data-ext-link")?$(this).attr("data-ext-link"):"#"+d;$('<li class=""><a href="'+d+'" title="'+b+'" >'+c+"</a></li>").appendTo($("nav ul"))})},reset:function(){$("nav ul li").removeClass("active")}};
GUI.prototype.pages=function(){this.init=function(){this.$pages=$("<pages></pages>");$("article.page").detach().appendTo(this.$pages)};this.get=function(c){var b=this.$pages.find('article[id="'+c+'"]');return b=0<b.length?b:$('article[id="'+c+'"]')};this.isShowing=function(c){return 0<$("#page article.page"+("undefined"!==typeof c?'[id="'+c+'"]':"")).length};this.open=function(c){if(!this.isShowing(c)){c=this.get(c);if(1!==c.length)return console.error("page not found");this.isShowing()&&this.close();
$("#page .content").prepend(c.show()).trigger("change");$(window).bind("resize.pageEvents",function(){$("#page").trigger("change")})}};this.close=function(){var c;c=$("#page .page").detach();this.$pages.append(c);$("#page").trigger("change");this.nav.reset();$("#overlay").hide();$("#overlay, header").unbind(".pageEvents");$(window).unbind(".pageEvents")};return this};
GUI.prototype.showFeedback=function(c,b){var d,b=b?1E3*b:1E4;$("#feedback-bar p").eq(1).remove();$("#feedback-bar p").html()!==c&&(d=$("<p></p>"),d.text(c),$("#feedback-bar").prepend(d));$("#feedback-bar").trigger("change");setTimeout(function(){typeof d!=="undefined"&&d.remove();$("#feedback-bar").trigger("change")},b)};GUI.prototype.hideFeedback=function(){$("#feedback-bar p").remove();$("#feedback-bar").trigger("change")};
GUI.prototype.alert=function(c,b,d){var e=$("#dialog-alert"),d=d||"error",d="normal"===d?"":"alert alert-block alert-"+d;e.find(".modal-header h3").text(b||"Alert");e.find(".modal-body p").removeClass().addClass(d).html(c).capitalizeStart();e.modal({keyboard:!0,show:!0});e.on("hidden",function(){e.find(".modal-header h3, .modal-body p").html("")})};
GUI.prototype.confirm=function(c,b){var d,e,g,h,i;"string"===typeof c?d=c:"string"===typeof c.msg&&(d=c.msg);d="undefined"!==typeof d?d:"Please confirm action";e="undefined"!==typeof c.heading?c.heading:"Are you sure?";g="undefined"!==typeof c.errorMsg?c.errorMsg:"";h="undefined"!==typeof c.dialog?c.dialog:"confirm";b="undefined"!==typeof b?b:{};b.posButton=b.posButton||"Confirm";b.negButton=b.negButton||"Cancel";b.posAction=b.posAction||function(){return false};b.negAction=b.negAction||function(){return false};
b.beforeAction=b.beforeAction||function(){};i=$("#dialog-"+h);i.find(".modal-header h3").text(e);i.find(".modal-body .msg").html(d).capitalizeStart();i.find(".modal-body .alert-error").html(g);i.modal({keyboard:!0,show:!0});i.on("shown",function(){b.beforeAction.call()});i.find("button.positive").on("click",function(){b.posAction.call();i.modal("hide")}).text(b.posButton);i.find("button.negative").on("click",function(){b.negAction.call();i.modal("hide")}).text(b.negButton);i.on("hide",function(){i.off("shown hidden hide");
i.find("button.positive, button.negative").off("click")});i.on("hidden",function(){i.find(".modal-body .msg, .modal-body .alert-error, button").text("")})};
GUI.prototype.updateStatus={connection:function(c){console.log("updating online status in menu bar to:");console.log(c);!0===c?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-signal-diag").attr("title","It appears there is currently an Internet connection available."),$(".drawer #status").removeClass("offline waiting").text("")):!1===c?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-cancel").attr("title","It appears there is currently no Internet connection"),
$(".drawer #status").removeClass("waiting").addClass("offline").text("Offline. ")):$(".drawer #status").removeClass("offline").addClass("waiting").text("Waiting. ")},edit:function(c){c?$("header #status-editing").removeClass().addClass("ui-icon ui-icon-pencil").attr("title","Form is being edited."):$("header #status-editing").removeClass().attr("title","")},support:function(c){var b=gui.pages().get("settings");0<b.length&&(console.debug("updating browser support for "+c),b.find("#settings-browserSupport-"+
c+" span.ui-icon").addClass("ui-icon-check"))},offlineLaunch:function(c){$(".drawer #status-offline-launch").text(c?"Offline Launch: Yes":"Offline Launch: No")}};
GUI.prototype.display=function(){var c,b;b=$("header");var d=$("#feedback-bar"),e=$("#page");0<d.find("p").length?(c=b.outerHeight(),b=this.pages().isShowing()?b.outerHeight()+d.outerHeight():b.outerHeight()+d.outerHeight()-e.outerHeight()):(c=b.outerHeight()-d.outerHeight(),b=this.pages().isShowing()?b.outerHeight():b.outerHeight()-e.outerHeight());d.css("top",c);e.css("top",b)};
GUI.prototype.setSettings=function(c){var b,d=this;console.log("gui updateSettings() started");$.each(c,function(c,g){b=g?d.pages().get("settings").find('input[name="'+c+'"][value="'+g+'"]'):d.pages().get("settings").find('input[name="'+c+'"]');0<b.length&&b.attr("checked",g?!0:!1).trigger("change")})};function getGetVariable(c){for(var b=window.location.search.substring(1).split("&"),d=0;d<b.length;d++){var e=b[d].split("=");if(e[0]==c)return encodeURI(e[1])}return!1}
(function(c){c.fn.equalWidth=function(){var b=0;return this.each(function(){c(this).width()>b&&(b=c(this).width())}).each(function(){c(this).width(b)})};c.fn.reverse=[].reverse;c.fn.alphanumeric=function(b){b=c.extend({ichars:"!@#$%^&*()+=[]\\';,/{}|\":<>?~`.- ",nchars:"",allow:""},b);return this.each(function(){b.nocaps&&(b.nchars+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");b.allcaps&&(b.nchars+="abcdefghijklmnopqrstuvwxyz");for(var d=b.allow.split(""),e=0;e<d.length;e++)-1!=b.ichars.indexOf(d[e])&&(d[e]="\\"+
d[e]);b.allow=d.join("|");var g=b.ichars+b.nchars,g=g.replace(RegExp(b.allow,"gi"),"");c(this).keypress(function(b){var c;c=b.charCode?String.fromCharCode(b.charCode):String.fromCharCode(b.which);g.indexOf(c)!=-1&&b.preventDefault();b.ctrlKey&&c=="v"&&b.preventDefault()});c(this).bind("contextmenu",function(){return false})})};c.fn.numeric=function(b){var d="abcdefghijklmnopqrstuvwxyz",d=d+d.toUpperCase(),b=c.extend({nchars:d},b);return this.each(function(){c(this).alphanumeric(b)})};c.fn.alpha=function(b){b=
c.extend({nchars:"1234567890"},b);return this.each(function(){c(this).alphanumeric(b)})};c.fn.capitalizeStart=function(b){b||(b=1);var c=this.contents().filter(function(){return 3==this.nodeType}).first(),e=c.text(),b=e.split(" ",b).join(" ");c.length&&(c[0].nodeValue=e.slice(b.length),c.before('<span class="capitalize">'+b+"</span>"))};c.fn.addScrollBar=function(){return this.each(function(){var b=c(this),d=c(this).find("ol");b.css("overflow","hidden");var e=d.height()-b.height();if(0<e){var g=e/
d.height(),g=Math.round((1-g)*b.height()),g=g-g%2;c("#records .column.middle").html('<div id="slider-wrap" class="ui-corner-all"><div id="slider-vertical"></div></div>');c("#slider-wrap").height(b.outerHeight());c("#slider-vertical").slider({orientation:"vertical",range:"max",min:0,max:100,value:100,slide:function(b,c){d.css({top:-((100-c.value)*e/100)})}});c("#slider-wrap").css("margin-top",c("#records-saved h3").outerHeight(!0));c(".ui-slider-handle").css({height:g,"margin-bottom":-0.5*g});b=c("#slider-vertical").height();
g=b-g;b=0.5*(b-g);c(".ui-slider").css({height:g,"margin-top":b});c(".ui-slider-range").css({top:-b});c("#slider-wrap").click(function(){c("#slider-vertical").slider("value",0);d.css({top:-e})})}})}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Form(c,b,d){function e(a){function b(a,c,j){this.selector="undefined"!==typeof a&&a?a:"*";this.filter=j="undefined"!==typeof j&&null!==j?j:{};this.filter.noTemplate="undefined"!==typeof j.noTemplate?j.noTemplate:!0;this.filter.onlyLeaf="undefined"!==typeof j.onlyLeaf?j.onlyLeaf:!1;this.filter.onlyTemplate="undefined"!==typeof j.onlyTemplate?j.onlyTemplate:!1;this.filter.noEmpty="undefined"!==typeof j.noEmpty?j.noEmpty:!1;this.index=c}var c,d=this,a=a.replace(/<[\/]?instance(>|\s+[^>]*>)/gi,
"");this.xml=$.parseXML(a);this.$=c=$(this.xml);XPathJS.bindDomLevel3XPath();this.node=function(a,c,r){return new b(a,c,r)};b.prototype.get=function(){var a,b;a=!0===this.filter.onlyTemplate?c.xfind(this.selector).filter("[template]"):!0===this.filter.noTemplate?c.xfind(this.selector).not("[template], [template] *"):c.xfind(this.selector);!0===this.filter.noEmpty?a=a.filter(function(){b=$(this).text();return 0===$(this).children().length&&0<$.trim(b).length}):!0===this.filter.onlyLeaf&&(a=a.filter(function(){return 0===
$(this).children().length}));return a="undefined"!==typeof this.index&&null!==this.index?a.eq(this.index):a};b.prototype.setVal=function(a,b,c){var j,r;r=this.getVal()[0];a="undefined"!==typeof a&&null!==a?$.isArray(a)?a.join(" "):a:"";a=this.convert(a,c);j=this.get();if(1===j.length&&$.trim(a.toString())!==$.trim(r.toString()))return j.text(a),a=this.validate(b,c),f.trigger("dataupdate",j.prop("nodeName")),a;if(1<j.length)return console.error("nodeset.setVal expected nodeset with one node, but received multiple"),
null;0===j.length&&console.error("Data node: "+this.selector+" with null-based index: "+this.index+" not found!");return null};b.prototype.getVal=function(){var a=[];this.get().each(function(){a.push($(this).text())});return a};b.prototype.clone=function(a){var b,c;b=this.get();a=a||b;1===b.length&&1===a.length?(b.clone().insertAfter(a).find("*").andSelf().removeAttr("template"),c=[b.prop("nodeName")],b.find("*").each(function(){c.push($(this).prop("nodeName"))}),f.trigger("dataupdate",c.join())):
console.error("node.clone() function did not receive origin and target nodes")};b.prototype.remove=function(){var a=this.get();0<a.length?(a.remove(),f.trigger("dataupdate",a.prop("nodeName"))):console.error("could not find node "+this.selector+" with index "+this.index+" to remove ")};b.prototype.convert=function(a,b){return""===a.toString()?a:"undefined"!==typeof b&&null!==b&&"undefined"!==typeof this.types[b.toLowerCase()]&&"undefined"!==typeof this.types[b.toLowerCase()].convert?this.types[b.toLowerCase()].convert(a):
a};b.prototype.validate=function(a,b){var c,j;c=this.getVal()[0];if(""===c.toString())return!0;if("undefined"==typeof b||null===b||"undefined"==typeof this.types[b.toLowerCase()])b="string";c=this.types[b.toLowerCase()].validate(c);j="undefined"!==typeof a&&null!==a&&0<a.length?d.evaluate(a,"boolean",this.selector,this.index):!0;return c&&j};b.prototype.types={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},decimal:{validate:function(a){return!isNaN(a-
0)&&null!==a?!0:!1}},"int":{validate:function(a){return!isNaN(a-0)&&null!==a&&Math.round(a)==a?!0:!1}},date:{validate:function(a){return"Invalid Date"!==(new Date(a)).toString()},convert:function(a){a=new Date(a);return a.getUTCFullYear().toString().pad(4)+"-"+(a.getUTCMonth()+1).toString().pad(2)+"-"+a.getUTCDate().toString().pad(2)}},datetime:{validate:function(a){console.debug("datetime validation function received: "+a+" type:"+typeof a);return"Invalid Date"!==(new Date(a.toString())).toString()},
convert:function(a){var b=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2}):([0-9]{2})$/,c=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2})$/;if("Invalid Date"!==(new Date(a)).toString()&&b.test(a))return a;if("Invalid Date"==(new Date(a)).toString()&&c.test(a))return a+":00";a=new Date(a);return"Invalid Date"!==a.toString()?a.toISOLocalString():a.toString()}},time:{validate:function(a){var b=new Date,a=a.toString().split(":");
if(2>a.length)return!1;a[2]=a[2]?a[2]:0;return 24>a[0]&&0<=a[0]&&60>a[1]&&0<=a[1]&&60>a[2]&&0<=a[2]&&"Invalid Date"!==b.toString()},convert:function(a){var b=a.toString().split(":");$.each(b,function(a,c){b[a]=c.toString().pad(2)});return b.join(":")}},barcode:{validate:function(){return!0}},geopoint:{validate:function(a){a=a.toString().split(" ");return""!==a[0]&&-90<=a[0]&&90>=a[0]&&""!==a[1]&&-180<=a[1]&&180>=a[1]&&("undefined"==typeof a[2]||!isNaN(a[2]))&&("undefined"==typeof a[3]||!isNaN(a[3])&&
0<=a[3])},convert:function(a){return $.trim(a.toString())}},binary:{validate:function(){return!0}}}}function g(a){this.$=f=$(a)}var h,i,k,f,y;this.ex=function(a,b,c,d){return h.evaluate(a,b,c,d)};this.sfv=function(){return k.setAllVals()};this.data=function(a){return new e(a)};this.getDataO=function(){return h};this.getDataEditO=function(){return i.get()};this.form=function(a){return new g(a)};this.getFormO=function(){return k};this.getDataXML=function(){return h.getXML()};this.validateAll=function(){return k.validateAll()};
this.outputUpdate=function(){return k.outputUpdate()};this.init=function(){y=$(c).clone().appendTo("<original></original>");h=new e(b);k=new g(c);h.init();"undefined"!==typeof d&&0<d.length&&(i=new e(d),i.init(),h.load(i));k.init()};this.getDataStr=function(a,b){return h.getStr(a,b)};this.getRecordName=function(){return k.recordName.get()};this.setRecordName=function(a){return k.recordName.set(a)};this.getRecordStatus=function(){return k.recordStatus.get()};this.setRecordStatus=function(a){return k.recordStatus.set(a)};
this.setEditStatus=function(a){return k.editStatus.set(a)};this.getEditStatus=function(){return k.editStatus.get()};this.getName=function(){return f.find("#form-title").text()};this.reset=function(){$("#form-languages").remove();f.replaceWith(y)};this.validateForm=function(){return k.validateAll()};this.isValid=function(){return k.isValid()};e.prototype.init=function(){var a,b;this.node(null,null,{noEmpty:!0,noTemplate:!1}).get().each(function(){b=$(this).text();$(this).text($.trim(b))});a=this.node(":first",
0).get();this.namespace=a.attr("xmlns");a.removeAttr("xmlns");this.cloneAllTemplates()};e.prototype.load=function(a){var b,c,d,m,e,g,h,l,i,t=this,o={noTemplate:!0,noEmpty:!0};b=a.node(null,null,o).get();this.node(null,null,o).get().each(function(){$(this).text("")});b.each(function(){$(this).prop("nodeName");m=k.generateName($(this));c=a.node(m).get().index($(this));e=$(this).text();h=f.find('[name="'+m+'"]').eq(0);d=0<h.length?k.input.getXmlType(h):"string";g=t.node(m,c);l=g.get();1<l.length?console.error("Found multiple nodes with path: "+
m+" and index: "+c):1===l.length?g.setVal(e,null,d):0<t.node(m,c,{noTemplate:!1}).get().length?(i=t.node(m,0,{noTemplate:!1}).get().closest("[template]"),t.cloneTemplate(k.generateName(i),c-1),g=t.node(m,c),1===g.get().length?g.setVal(e,null,d):console.error("Error occured trying to clone template node to set the repeat value of the instance to be edited.")):1===$(this).parent("meta").length?$(this).clone().appendTo(t.get().children().eq(0).children("meta")):console.error("did not find node with path: "+
m+" and index: "+c+" so could not load data")});b=this.node("*>meta>instanceID");1!==b.get().length?console.error("instanceID was not found (or multiple)! Edited submission will not be successful."):(1!==this.node("*>meta>deprecatedID").get().length&&(o=$.parseXML("<deprecatedID/>").documentElement,$(o).appendTo(this.node("*>meta").get())),this.node("*>meta>deprecatedID").setVal(b.getVal()[0],null,"string"),b.setVal("",null,"string"),console.debug("finished loading instance values to be edited"))};
e.prototype.cloneTemplate=function(a,b){var c,d,f=this.node(a,0,{onlyTemplate:!0}),f=0===f.get().length?this.node(a,0):f;d=f.get().prop("nodeName");c=this.node(a,b).get();1===f.get().length&&1===c.length&&c.next().prop("nodeName")!==d?f.clone(c):c.next().prop("nodeName")!==d&&console.error("Could not find template node and/or node to insert the clone after")};e.prototype.cloneAllTemplates=function(a){var b=this;if("undefined"==typeof a||0===a.length)a=this.$.find(":first");a.children("[template]").each(function(){"undefined"==
typeof $(this).parent().attr("template")&&0===$(this).siblings($(this).prop("nodeName")).not("[template]").length&&$(this).clone().insertAfter($(this)).find("*").andSelf().removeAttr("template")});a.children().not("[template]").each(function(){b.cloneAllTemplates($(this))})};e.prototype.get=function(){return this.$||null};e.prototype.getXML=function(){return this.xml||null};e.prototype.getStr=function(a,b){var c,a="undefined"!==typeof a?a:!1,b="undefined"!==typeof b?b:!0;c=$("<root></root");this.$.find(":first").clone().appendTo(c);
!1===a&&c.find("[template]").remove();!0===b&&("undefined"!==typeof this.namespace&&0<this.namespace.length)&&c.children().eq(0).attr("xmlns",this.namespace);c=(new XMLSerializer).serializeToString(c.children().eq(0)[0]);c=c.replace(/xmlns\=\"[A-z0-9\:\/\.\-\%\_\?&amp;]*\"/gi," ");return c=c.replace(/\t/g,"")};e.prototype.makeBugCompliant=function(a,b){var c,d,f,e=a;for(c=0;c<b.length;c++)d=b.eq(c).attr("name"),f=b.eq(c).siblings('[name="'+d+'"]').andSelf().index(b.eq(c)),e=e.replace(d,d+"["+(f+1)+
"]");return e};e.prototype.evaluate=function(a,b,c,d){var m,g,h,b=b||"any",d=d||0;m=new e(this.getStr(!1,!1));"undefined"!==typeof c&&null!==c?(m=m.node(c,d,{}).get()[0],0<f.find('[name="'+c+'"]').parents(".jr-repeat").length&&(c=f.find('[name="'+c+'"]').eq(d).parents(".jr-repeat"),a=this.makeBugCompliant(a,c))):m=m.getXML();c={"0":["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean","BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],
9:["node","FIRST_ORDERED_NODE_TYPE"]};for(g in c)if(g=Number(g),c[g][0]==b)break;else g=0;a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&quot;/g,'"');try{h=document.evaluate(a,m,null,g,null);if(0===g){for(g in c)if(g=Number(g),g==Number(h.resultType))return h=0<g&&4>g?h[c[g][2]]:h,console.debug("evaluated "+a+" to: "+h),h;console.error("Expression: "+a+" did not return any boolean, string or number value as expected")}console.debug("evaluated "+a+" to: "+h[c[g][2]]);return h[c[g][2]]}catch(v){return console.error("Error occurred trying to evaluate: "+
a+", message: "+v.message),null}};g.prototype.init=function(){var a;this.checkForErrors();if("undefined"==typeof h||!(h instanceof e))return console.error("variable data needs to be defined as instance of DataXML");f.find('label>input[type="checkbox"][required], label>input[type="radio"][required]').parent().parent("fieldset").find("legend:eq(0)").append('<span class="required">*</span><br />');f.parent().find("label>select[required], label>textarea[required], :not(#jr-preload-items, #jr-calculated-items)>label>input[required]").not('[type="checkbox"], [type="radio"]').parent().each(function(){$(this).children("span:not(.jr-option-translations):last").after('<span class="required">*</span><br />')});
f.find(".jr-hint ~ input, .jr-hint ~ select, .jr-hint ~ textarea").after('<span class="hint" >?</span>');f.find('input[type="radio"]').each(function(){a=$(this).attr("name");$(this).attr("data-name",a)});f.find("h2").first().append("<span/>");this.repeat.init();this.setAllVals();this.widgets.init();this.bootstrapify();this.branch.init();this.grosslyViolateStandardComplianceByIgnoringCertainCalcs();this.calcUpdate();this.outputUpdate();this.setEventHandlers();this.preloads.init();this.setLangs();this.editStatus.set(!1);
setTimeout(function(){f.fixLegends()},500)};g.prototype.checkForErrors=function(){var a,b=[],c,d,g,e,n,v,l,i,k,o,s,p,u,q,z,A,w,x;l=f.find("#stats");a=parseInt(l.find('[id="jrItem"]').text(),10);c=parseInt(l.find('[id="jrInput"]').text(),10);d=parseInt(l.find('[id="jrUpload"]').text(),10);g=parseInt(l.find('[id="jrTrigger"]').text(),10);e=parseInt(l.find('[id="jrConstraint"]').text(),10);n=parseInt(l.find('[id="jrRelevant"]').text(),10);v=parseInt(l.find('[id="jrCalculate"]').text(),10);l=parseInt(l.find('[id="jrPreload"]').text(),
10);i=f.find('input[type="radio"]').length;k=f.find('input[type="checkbox"]').length;f.find("select");o=f.find('option[value!=""]').length;s=f.find('textarea, input:not([type="radio"],[type="checkbox"])').length;p=f.find(".trigger").length;u=f.find('[data-relevant]:not([type="radio"],[type="checkbox"])').length;q=f.find('input[data-relevant][type="radio"],input[data-relevant][type="checkbox"]').parent().parent("fieldset").length;z=f.find('[data-constraint]:not([type="radio"],[type="checkbox"])').length;
A=f.find('input[data-constraint][type="radio"],input[data-constraint][type="checkbox"]').parent().parent("fieldset").length;w=f.find("[data-calculate]").length;x=f.find("#jr-preload-items input").length;a!==o+i+k&&console.error(" total select fields differs between XML form and HTML form");c+d!==s-w-x&&console.error(" total amount of input/upload fields differs between XML form and HTML form");g!=p&&console.error(" total triggers differs between XML form and HTML form");n!=u+q&&console.error(" total amount of branches differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form)");
e!=z+A&&console.error(" total amount of constraints differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form). Note that constraints on &lt;trigger&gt; elements are ignored in the transformation and could cause this error too.");v!=w&&console.error(" total amount of calculated items differs between XML form and HTML form");l!=x&&console.error(" total amount of preload items differs between XML form and HTML form");f.find("[name]").each(function(){$.inArray($(this).attr("name"),
b)&&b.push($(this).attr("name"))});for(a=0;a<b.length;a++)1>h.node(b[a]).get().length&&console.error("Found name attribute: "+b[a]+" that does not have a corresponding data node. Transformation error or XML form error (relative nodesets perhaps?")};g.prototype.input={getWrapNodes:function(a){var b=this.getInputType(a.eq(0));return"radio"==b||"checkbox"==b?a.parent("label").parent("fieldset"):"fieldset"==b?a:a.parent("label")},getProps:function(a){return 1!==a.length?console.error("getProps(): no input node provided or multiple"):
{path:this.getName(a),ind:this.getIndex(a),inputType:this.getInputType(a),xmlType:this.getXmlType(a),constraint:a.attr("data-constraint"),relevant:a.attr("data-relevant"),val:this.getVal(a),required:void 0!==a.attr("required")?!0:!1,enabled:this.isEnabled(a),multiple:this.isMultiple(a)}},getInputType:function(a){return 1!==a.length?"":"input"==a.prop("nodeName").toLowerCase()?0<a.attr("type").length?a.attr("type").toLowerCase():console.error("<input> node has no type"):"select"==a.prop("nodeName").toLowerCase()?
"select":"textarea"==a.prop("nodeName").toLowerCase()?"textarea":"fieldset"==a.prop("nodeName").toLowerCase()?"fieldset":console.error("unexpected input node type provided")},getXmlType:function(a){return 1!==a.length?console.error("getXMLType(): no input node provided or multiple"):a.attr("data-type-xml")},getName:function(a){return 1!==a.length?console.error("getName(): no input node provided or multiple"):"radio"==this.getInputType(a)?a.attr("data-name"):a.attr("name")&&0<a.attr("name").length?
a.attr("name"):console.error("input node has no name")},getIndex:function(a){var b,c,d;if(1!==a.length)return console.error("getIndex(): no input node provided or multiple");b=this.getInputType(a);c=this.getName(a);d=this.getWrapNodes(a);return("radio"===b&&c!==a.attr("name")?this.getWrapNodes(f.find('[data-name="'+c+'"]')):this.getWrapNodes(f.find('[name="'+c+'"]'))).index(d)},isMultiple:function(a){return"checkbox"==this.getInputType(a)||void 0!==a.attr("multiple")?!0:!1},isEnabled:function(a){return void 0!==
a.attr("disabled")||0!==a.parents("fieldset:disabled").length?!1:!0},getVal:function(a){var b,c=[],d;if(1!==a.length)return console.error("getVal(): no inputNode provided or multiple");b=this.getInputType(a);d=this.getName(a);return"radio"==b?this.getWrapNodes(a).find("input:checked").val()||"":"checkbox"==b?(this.getWrapNodes(a).find('input[name="'+d+'"]:checked').each(function(){c.push($(this).val())}),c):a.val()||""},setVal:function(a,b,c){b=b||0;if("radio"==this.getInputType(f.find('[data-name="'+
a+'"]').eq(0)))return this.getWrapNodes(f.find('[data-name="'+a+'"]')).eq(b).find('input[value="'+c+'"]').attr("checked",!0);a=this.getWrapNodes(f.find('[name="'+a+'"]')).eq(b).find("input, select, textarea");b=this.getInputType(a.eq(0));if("date"===b||"datetime"===b)c=h.node().convert(c,b),console.debug("converting date before setting input field to: "+c);!0===this.isMultiple(a.eq(0))&&(c=c.split(" "));a.val(c)}};g.prototype.setAllVals=function(){var a,b,c,d=this;h.node(null,null,{noEmpty:!0}).get().each(function(){c=
$(this).text();b=d.generateName($(this));a=h.node(b).get().index($(this));d.input.setVal(b,a,c)})};g.prototype.setLangs=function(){var a,b,c,d,g=this,e=f.find("#form-languages").attr("data-default-lang");$("#form-languages").detach().insertBefore($("form.jr").parent());if(!e||""===e)e=$("#form-languages a:eq(0)").attr("lang");console.debug("default language is: "+e);2>$("#form-languages a").length?(f.find("[lang]").addClass("active"),f.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&
$(this).removeClass("active")}),this.setHints()):($("#form-languages a").click(function(e){e.preventDefault();a=$(this).attr("lang");$("#form-languages a").removeClass("active");$(this).addClass("active");f.find("[lang]").removeClass("active").filter('[lang="'+a+'"], [lang=""]').addClass("active");f.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&$(this).removeClass("active")});f.find("select > option").not('[value=""]').each(function(){c=$(this).text();
b=$(this).attr("value");d=$(this).parent("select").siblings(".jr-option-translations").children('.active[data-option-value="'+b+'"]').text().trim();d="undefined"!==typeof d&&0<d.length?d:c;$(this).text(d)});f.find("legend span.active:not(.jr-hint, .jr-constraint-msg), label span.active:not(.jr-hint, .jr-constraint-msg)").each(function(){0===$(this).text().trim().length&&$(this).text("[MISSING TRANSLATION]")});g.setHints();f.trigger("changelanguage")}),$('#form-languages a[lang="'+e+'"]').click())};
g.prototype.setHints=function(){var a,b;f.find("*>.jr-hint").parent().each(function(){b="label"!==$(this).prop("nodeName").toLowerCase()&&"fieldset"!==$(this).prop("nodeName").toLowerCase()?$(this).parent("fieldset"):$(this);a=0<b.length?$(this).find(".jr-hint.active").text().trim():$(this).find("span.jr-hint").text().trim();0<a.length?b.find(".hint").attr("title",a):b.find(".hint").removeAttr("title")});f.find(".hint[title]").tooltip({placement:"right"})};g.prototype.editStatus={set:function(a){f.attr("data-edited",
Boolean(a));f.trigger("edit",a)},get:function(){return"true"===f.attr("data-edited")?!0:!1}};g.prototype.recordName={set:function(a){f.attr("data-stored-with-key",a);f.find("h2 span").text(a)},get:function(){return f.attr("data-stored-with-key")||null},reset:function(){f.removeAttr("data-stored-with-key")}};g.prototype.recordStatus={set:function(a){f.attr("data-stored-final",a.toString())},get:function(){return"true"===f.attr("data-stored-final")?!0:!1},reset:function(){f.removeAttr("data-stored-final")}};
g.prototype.branch={init:function(){f.on("click",".jr-branch",function(){var a=$(this);$(this).hasClass("busy")||($(this).hasClass("show")?$(this).addClass("busy").removeClass("show").next().hide("blind",{},600,function(){a.removeClass("busy")}):$(this).addClass("busy show").next().show("blind",{},600,function(){a.removeClass("busy");a.next().fixLegends()}))});this.update()},update:function(a){var b,c,d,e,g,n={},i=this;e="undefined"!==typeof a?a.split(","):[];g=0<e.length?[]:["[data-relevant]"];for(a=
0;a<e.length;a++)g.push('[data-relevant*="'+e[a]+'"]');f.find(g.join()).each(function(){b=k.input.getProps($(this));c=k.input.getWrapNodes($(this));if(!("radio"==b.inputType||"checkbox"==b.inputType)||!n[b.path])if(1!==c.length)console.error("could not find branch node");else{try{d=h.evaluate(b.relevant,"boolean",b.path,b.ind)}catch(a){console.error('Serious error occurred trying to evaluate skip logic for node with name: "'+b.path+'" (message: '+a.message+")");return}n[b.path]=!0;!0===d?i.enable(c):
i.disable(c)}});return!0},enable:function(a){console.debug("enabling branch");a.prev(".jr-branch").hide("slow",function(){$(this).remove()});a.removeClass("disabled").show("blind",{direction:"up"},1E3,function(){$(this).fixLegends()});return"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").removeAttr("disabled"):a.removeAttr("disabled")},disable:function(a){console.debug("disabling branch");a.addClass("disabled").hide();0===a.prev(".jr-branch").length&&(a.before('<div class="jr-branch"></div>'),
a.clearInputs("change"));return"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").attr("disabled","disabled"):a.attr("disabled","disabled")}};g.prototype.outputUpdate=function(a){var b,c,d,e,g=this,n="";setTimeout(function(){console.log("updating active outputs that contain: "+a);d="undefined"!==typeof a?a.split(","):[];e=0<d.length?[]:[".jr-output[data-value]"];for(b=0;b<d.length;b++)e.push('.jr-output[data-value*="'+d[b]+'"]');f.find(":not([disabled]) span.active").find(e.join()).each(function(){try{c=
$(this).attr("data-value"),n=h.evaluate(c,"string")}catch(a){console.error("error occurred trying to evaluate output value from expression: "+c+", (message:"+a.message+")"),n="[ERROR]"}$(this).text(n)});f.fixLegends();g.setHints()},1)};g.prototype.grosslyViolateStandardComplianceByIgnoringCertainCalcs=function(){var a=f.find('[name$="/meta/instanceID"][data-calculate]');0<a.length&&(console.debug("Found meta/instanceID with binding that has a calculate attribute and removed this calculation. It ain't right!"),
a.removeAttr("data-calculate"))};g.prototype.calcUpdate=function(a){var b,c,d,e,g,n,i;n="undefined"!==typeof a?a.split(","):[];i=0<n.length?[]:["input[data-calculate]"];for(a=0;a<n.length;a++)i.push('input[data-calculate*="'+n[a]+'"]');f.find("#jr-calculated-items").find(i.join()).each(function(){b=$(this).attr("name");c=$(this).attr("data-calculate");d=$(this).attr("data-type-xml");g=$(this).attr("data-constraint");e=h.evaluate(c,"string",b,null);h.node(b,null).setVal(e,g,d)})};g.prototype.bootstrapify=
function(){f.find(".trigger").addClass("alert alert-block");f.find(".jr-constraint-msg").addClass("alert alert-error");f.find("label:not(.geo), fieldset").addClass("clearfix");f.find(":checkbox, :radio").each(function(){var a=$(this).parent("label");$(this).detach().prependTo(a)});$("fieldset:not(.jr-appearance-compact)>label, fieldset:not(.jr-appearance-compact)>legend").children("img,video,audio").parent().addClass("ui-helper-clearfix with-media")};g.prototype.widgets={init:function(){this.compactWidget();
this.radioWidget();this.dateWidget();this.timeWidget();this.dateTimeWidget();this.selectOneWidget();this.selectMultiWidget();this.pageBreakWidget();this.readonlyWidget();this.gridWidget();this.spinnerWidget();this.sliderWidget();this.geopointWidget();this.barcodeWidget();this.fileWidget()},compactWidget:function(){f.find(".jr-appearance-compact>label>span").hide()},radioWidget:function(){},dateWidget:function(){f.find('input[type="date"]').each(function(){var a=$(this).parent("label"),a=a.hasClass("jr-appearance-month-year")?
"year":a.hasClass("jr-appearance-year")?"decade":"month",b="year"===a?"yyyy-mm":"decade"===a?"yyyy":"yyyy-mm-dd",c=$('<div class="input-append date" ><input class="novalidate input-small" type="text" value="'+$(this).val()+'" placeholder="'+b+'" /><span class="add-on"><i class="icon-th"></i></span></div>'),d=$(this);$(this).hide().after(c);console.debug("startView: "+a);c.datepicker({format:b,autoclose:!0,todayHighlight:!0,startView:a}).find("input").on("change changeDate",function(){var a=$(this).val(),
a="yyyy-mm"===b?a+"-01":"yyyy"===b?a+"-01-01":a;d.val(h.node().convert(a,"date")).trigger("change");return!1})})},timeWidget:function(){f.find('input[type="time"]').each(function(){var a=$(this).val();$(this).addClass("timepicker-default input-small").after('<span class="add-on"><i class="icon-time"></i></span>').parent("label").addClass("input-append bootstrap-timepicker-component").find('input[type="time"]').timepicker({defaultTime:0<a.length?"value":"current",showMeridian:!1}).val(a)})},dateTimeWidget:function(){f.find('input[type="datetime"]').each(function(){function a(){if(0<
e.val().length&&0<g.val().length){var a=e.val().split("-"),c=g.val().split(":");console.log("changing datetime");b.val((new Date(a[0],a[1]-1,a[2],c[0],c[1])).toISOLocalString()).trigger("change")}}var b=$(this),c=(0<$(this).val().length?(new Date($(this).val())).toISOLocalString():"").split("T"),d=c[0],c=c[1]&&4<c[1].length?c[1].substring(0,5):"",d=$('<div class="input-append date" ><input class="novalidate input-small" type="text" value="'+d+'" placeholder="yyyy-mm-dd"/><span class="add-on"><i class="icon-th"></i></span></div>'),
f=$('<div class="input-append bootstrap-timepicker-component"><input class="novalidate timepicker-default input-small" type="time" value="'+c+'"/><span class="add-on"><i class="icon-time"></i></span></div>'),e=d.find("input"),g=f.find("input");b.hide().after('<div class="datetimepicker" />');b.siblings(".datetimepicker").append(d).append(f);d.datepicker({format:"yyyy-mm-dd",autoclose:!0,todayHighlight:!0});g.timepicker({defaultTime:0<c.length?"value":"current",showMeridian:!1}).val(c);e.on("change changeDate",
function(){a();return!1});g.on("change",function(){a();return!1})})},selectOneWidget:function(){function a(){f.find("select:not([multiple])").removeData("selectpicker").siblings(".bootstrap-select").remove();f.find("select:not([multiple])").selectpicker({btnStyle:"btn"})}f.find("select:not([multiple])").find('[value=""]').text("None selected");f.on("changelanguage",a);a()},selectMultiWidget:function(){function a(){$("select[multiple]").removeData("multiselect").siblings(".bootstrap-multiselect").remove();
$("select[multiple]").multiselect({container:'<div class="btn-group bootstrap-multiselect" />',button:"btn"});$("select[multiple] ~ .bootstrap-multiselect .caret").addClass("pull-right")}f.find("select[multiple]").find('[value=""]').remove();f.on("changelanguage",a);a()},pageBreakWidget:function(){f.find(".jr-appearance-page-break input[readonly]").parent("label").each(function(){var a='name="'+$(this).find("input").attr("name")+'"';$('<fieldset class="jr-appearance-page-break" '+a+"></fieldset>").insertBefore($(this)).find("input").remove();
$(this).remove()})},readonlyWidget:function(){f.find('input[readonly]:not([data-type-xml="geopoint"])').parent("label").each(function(){var a=$(this).html(),b=$(this).find("input").attr("data-relevant"),c='name="'+$(this).find("input").attr("name")+'"';$('<fieldset class="trigger" '+("undefined"!==typeof b?'data-relevant="'+b+'" '+c:c)+"></fieldset>").insertBefore($(this)).append(a).find("input").remove();$(this).remove()})},gridWidget:function(){},spinnerWidget:function(){},sliderWidget:function(){},
geopointWidget:function(){console.log("initializing geopoint widget");f.find('input[data-type-xml="geopoint"]').each(function(){function a(a,b,f){"undefined"!==typeof google.maps.LatLng&&(t={zoom:f||15,center:new google.maps.LatLng(a,b),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},o=new google.maps.Map(k[0],t),c(),google.maps.event.addListener(o,"click",function(a){d(a.latLng.lat(),a.latLng.lng(),"","","change.bymap");c(a.latLng)}))}function b(){window.setTimeout(function(){o.panTo(s.getPosition())},
5E3)}function c(a){a=a||o.getCenter();"undefined"!==typeof s&&s.setMap(null);s=new google.maps.Marker({position:a,map:o,draggable:!0});google.maps.event.addListener(s,"dragend",function(){d(s.getPosition().lat(),s.getPosition().lng(),"","","change.bymap");b()});b()}function d(a,b,c,j,r){c=c||"";j=j||"";r=r||"change";f.val(Math.round(1E4*a)/1E4);e.val(Math.round(1E4*b)/1E4);g.val(Math.round(10*c)/10);h.val(Math.round(10*j)/10).trigger(r)}var f,e,g,h,i,k,t,o,s,p,u=$(this),q=$(this).parent("label");
p=$(this).val().split(" ");q.addClass("geopoint");u.hide().after('<div class="map-canvas"></div><label class="geo">latitude (x.y &deg;)<input class="novalidate" name="lat" type="number" step="0.0001" /></label><label class="geo">longitude (x.y &deg;)<input class="novalidate" name="long" type="number" step="0.0001" /></label><label class="geo">altitude (m)<input class="novalidate" name="alt" type="number" step="0.1" /></label><label class="geo">accuracy (m)<input class="novalidate" name="acc" type="number" step="0.1" /></label><button name="geodetect" type="button" class="btn btn-small">detect</button>');
k=q.find(".map-canvas");f=q.find('[name="lat"]');e=q.find('[name="long"]');g=q.find('[name="alt"]');h=q.find('[name="acc"]');i=q.find('button[name="geodetect"]');q.find("input").not(u).on("change change.bymap",function(b){var c=""!==f.val()?f.val():0,d=""!==e.val()?e.val():0,j=""!==g.val()?g.val():0,r=h.val();u.val(c+" "+d+" "+j+" "+r).trigger("change");"bymap"!==b.namespace&&a(c,d);return!1});navigator.geolocation||i.attr("disabled","disabled");"undefined"!==typeof google&&"undefined"!==typeof google.maps&&
a(0,0,1);p[3]&&h.val(p[3]);p[2]&&g.val(p[2]);p[1]&&e.val(p[1]);0<p[0].length&&f.val(p[0]).trigger("change");i.click(function(b){b.preventDefault();navigator.geolocation.getCurrentPosition(function(b){a(b.coords.latitude,b.coords.longitude);d(b.coords.latitude,b.coords.longitude,b.coords.altitude,b.coords.accuracy)});return!1});""===$(this).val()&&i.click()})},autoCompleteWidget:function(){},barcodeWidget:function(){},fileWidget:function(){f.find('input[type="file"]').attr("placeholder","not supported yet").attr("disabled",
"disabled")}};g.prototype.preloads={init:function(){var a,b,c,d,e,g=this;f.find("#jr-preload-items input").each(function(){a=$(this).attr("data-preload").toLowerCase();b=$(this).attr("data-preload-params").toLowerCase();c=$(this).attr("name");"undefined"!==typeof g[a]?(d=h.node(c).getVal()[0],g.setVal($(this),g[a]({param:b,curVal:d,node:$(this)}))):console.error('Preload "'+a+'"" not supported. May or may not be a big deal.')});h.node("*>meta>*").get().each(function(){a=null;c=$(this).prop("nodeName");
e=h.node("*>meta>"+c);d=e.getVal()[0];if(0===f.find('#jr-preload-items input[name$="/meta/'+c+'"][data-preload]').length)switch(c){case "instanceID":a="instance";b="";break;case "timeStart":a="timestamp";b="start";break;case "timeEnd":a="timestamp",b="end"}a&&g.setDataVal(e,g[a]({param:b,curVal:d,dataNode:e}),null,"string")})},setVal:function(a,b){a.val(b.toString()).trigger("change")},setDataVal:function(a,b){a.setVal(b,"string")},timestamp:function(a){var b,c=this;return"start"==a.param?0<a.curVal.length?
a.curVal:h.evaluate("now()","string"):"end"==a.param?(f.on("beforesave",function(){b=h.evaluate("now()","string");a.node?c.setVal(a.node,b):c.setDataVal(a.dataNode,b)}),h.evaluate("now()","string")):""},date:function(a){var b,c;return 0===a.curVal.length?(b=new Date(h.evaluate("today()","string")),a=b.getUTCFullYear().toString().pad(4),c=(b.getUTCMonth()+1).toString().pad(2),b=b.getUTCDate().toString().pad(2),a+"-"+c+"-"+b):a.curVal},property:function(a){return 0===a.curVal.length?"no device properties in enketo":
a.curVal},context:function(a){return 0===a.curVal.length?"application"==a.param?"enketo":a.param+" not supported in enketo":a.curVal},patient:function(a){return 0===a.curVal.length?"patient preload not supported in enketo":a.curVal},user:function(a){return 0===a.curVal.length?"user preload item not supported in enketo yet":a.curVal},uid:function(a){return 0===a.curVal.length?"no uid yet in enketo":a.curVal},browser:function(a){return 0===a.curVal.length?"name"==a.param?$.browser.webkit?"webkit":$.browser.mozilla?
"mozilla":$.browser.opera?"opera":$.browser.msie?"msie":"unknown":"version"==a.param?$.browser.version:a.param+" not supported in enketo":a.curVal},os:function(a){return 0===a.curVal.length?"not known":a.curVal},instance:function(a){return 0<a.curVal.length?a.curVal:h.evaluate("concat('uuid:', uuid())","string")}};g.prototype.repeat={init:function(){var a,b,c,d,e,g=this;f.find("fieldset.jr-repeat").prepend('<span class="repeat-number"></span>');f.find("fieldset.jr-repeat:not([data-repeat-fixed])").append('<button type="button" class="btn repeat"><i class="icon-plus"></i></button><button type="button" disabled="disabled" class="btn remove"><i class="icon-minus"></i></button>');
f.on("click","button.repeat:enabled",function(){g.clone($(this).parent("fieldset.jr-repeat"));return!1});f.on("click","button.remove:enabled",function(){g.remove($(this).parent("fieldset.jr-repeat.clone"));return!1});f.find("fieldset.jr-repeat").each(function(){c=$(this).attr("data-repeat-count")||"";b=0<c.length?parseInt(h.node(c).getVal()[0],10):0;d=h.node($(this).attr("name")).get().length;e=b>d?b:d;for(a=1;a<e;a++)g.clone($(this).siblings().andSelf().last(),"")})},clone:function(a,b){var c,d,
e,g,i,k,l=this;if(1!==a.length)return console.error("Nothing to clone"),!1;c=a.parent("fieldset.jr-group").children("fieldset.jr-repeat:not(.clone)").eq(0);d=c.clone(!1);d.find(".clone").remove();d.addClass("clone");d.insertAfter(a).parent(".jr-group").numberRepeats();d.hide().show(600);d.clearInputs(b);d.find(".invalid input, .invalid select, .invalid textarea").each(function(){l.setValid($(this))});e=f.find('fieldset.jr-repeat[name="'+a.attr("name")+'"]').index(a);g=[];d.find('input[type="radio"]').each(function(){-1===
$.inArray($(this).attr("data-name"),g)&&g.push($(this).attr("data-name"))});for(i=0;i<g.length;i++)k=(new Date).getTime().toString(),d.find('input[type="radio"][data-name="'+g[i]+'"]').attr("name",k);this.toggleButtons(c.parent());c=c.attr("name");0<c.length&&0<=e&&h.cloneTemplate(c,e);f.trigger("changerepeat");return!0},remove:function(a){var b=this,c=a.attr("name"),d=f.find('fieldset.jr-repeat[name="'+c+'"]').index(a),e=a.parent("fieldset.jr-group");a.hide(600,function(){a.remove();e.numberRepeats();
b.toggleButtons(e);f.trigger("changerepeat")});h.node(c,d).remove()},toggleButtons:function(a){console.debug("toggling repeat buttons");a="undefined"==typeof a||0===a.length||!a?a=f:a;a.find("button.repeat, button.remove").attr("disabled","disabled");a.find("fieldset.jr-repeat:last-child > button.repeat").removeAttr("disabled");a.find("fieldset.jr-repeat:not(:nth-child(2)) > button.remove").removeAttr("disabled")}};g.prototype.setEventHandlers=function(){var a,b,c=this;$("form.jr").attr("onsubmit",
"return false;");f.on("change validate","input, select, textarea",function(d){a=c.input.getProps($(this));b="validate"==d.type?a.enabled&&"hidden"!==a.inputType?h.node(a.path,a.ind).validate(a.constraint,a.xmlType):!0:h.node(a.path,a.ind).setVal(a.val,a.constraint,a.xmlType);console.log("data.set validation returned valid: "+b);b=a.enabled&&"hidden"!==a.inputType&&a.required&&1>a.val.length?!1:b;console.log('after "required" validation valid is: '+b);if("undefined"!==typeof b&&null!==b)return!1===
b?c.setInvalid($(this)):c.setValid($(this))});f.on("dataupdate",function(a,b){c.calcUpdate(b);c.branch.update(b);c.outputUpdate(b)});f.on("change changerepeat",function(){c.editStatus.set(!0)});f.on("changerepeat",function(){c.setAllVals()});$(window).resize(function(){f.fixLegends()});f.on("changelanguage",function(){c.outputUpdate()})};g.prototype.setValid=function(a){this.input.getWrapNodes(a).removeClass("invalid")};g.prototype.setInvalid=function(a){this.input.getWrapNodes(a).addClass("invalid")};
g.prototype.generateName=function(a){for(var b=[a.prop("nodeName")],a=a.parent();1==a.length&&"#document"!==a.prop("nodeName");)b.push(a.prop("nodeName")),a=a.parent();return"/"+b.reverse().join("/")};g.prototype.validateAll=function(){var a=this;f.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){a.setValid($(this))});f.find("input, select, textarea").not(".novalidate").trigger("validate");return this.isValid()};
g.prototype.isValid=function(){return 0<f.find(".invalid").length?!1:!0};g.prototype.addPageBreaks=function(){}}GUI.prototype.setCustomEventHandlers=function(){};Date.prototype.toISOLocalString=function(){var c,b,d,e;if("Invalid Date"==this.toString())return this.toString();c=this.getTimezoneOffset();b=0>c?"+":"-";d=Math.abs(Math.floor(c/60));d=10>d?"0"+d:d;e=10>c%60?"0"+c%60:c%60;return(new Date(this.getTime()-6E4*c)).toISOString().replace("Z",b+d+":"+e)};
String.prototype.pad=function(c){for(var b=this;b.length<c;)b="0"+b;return b};
(function(c){c.fn.numberRepeats=function(){return this.each(function(){c(this).find("fieldset.jr-repeat").each(function(){var b,d,e;0===c(this).prev("fieldset.jr-repeat").length&&(b=c(this).siblings("fieldset.jr-repeat"),d=b.length+1,1<d?(c(this).find("span.repeat-number").text("1"),e=2,b.each(function(){c(this).find("span.repeat-number").text(e);e++})):c(this).find("span.repeat-number").empty())})})};c.fn.clearInputs=function(b){b=b||"edit";return this.each(function(){c(this).find("input, select, textarea").each(function(){var d=
c(this).attr("type");"SELECT"===c(this).prop("nodeName").toUpperCase()&&(d="select");"TEXTAREA"===c(this).prop("nodeName").toUpperCase()&&(d="textarea");switch(d){case "date":case "number":case "search":case "color":case "range":case "url":case "email":case "password":case "text":case "file":case "hidden":case "textarea":c(this).val("").trigger(b);break;case "radio":case "checkbox":c(this).prop("checked")&&(c(this).prop("checked",!1),c(this).trigger(b));break;case "select":c(this)[0].selectedIndex=
-1;c(this).trigger(b);break;default:console.error("Unrecognized input type found when trying to reset: "+d),console.error(c(this))}})})};c.fn.fixLegends=function(){};c.fn.xfind=function(b){var c,e,b=b.replace(/\/\//g," "),b=b.replace(/^\//,""),b=b.replace(/\/\.$/,""),b=b.replace(/\//g,">"),b=b.replace(/\[([^@].*?)\]/g,function(b,c){return":has("+c+")"});if(0<=b.indexOf(">..")){b=b.split(/>\.\.>?/g);c=jQuery(b[0],this);for(e=1;e<b.length;e++)c=c.parent(b[e]);return c.get()}b=b.replace(/\./gi,"\\.");
return this.find(b)}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var form,source,url,$tabs,$upload,_error,state,error_msg='There were errors. Please see the "report" tab for details.',templateShow=!1;
$(document).ready(function(){state=new State;state.init();$("[title]").tooltip();_error=console.error;console.error=function(){addJsError(arguments[0]);gui.showFeedback(error_msg);return _error.apply(console,arguments)};state.source||($("#html5-form-source").hide(),$('li a[href="#html5-form-source"]').parent("li").remove());$('li a[href="#upload"]').tab("show");gui.setup();$('#upload-form [name="xml_file"]').change(function(){state.reset();$("#upload-form").submit();$("#upload-form")[0].reset()});
$("#upload-form").ajaxForm({dataType:"xml",beforeSubmit:function(c,b){var d=b.find('input[name="server_url"]').val()||"",e=b.find('input[name="form_id"]').val()||"";if(d.length>0)if(isValidUrl(d)){state.server=d;state.setUrl();if(e.length>0){state.id=e;state.setUrl()}}else{gui.alert("Not a valid server url");resetForm();return false}else{resetForm();return false}$("#upload .hurry").hide();$("#upload-form progress").show()},success:processResponse,error:function(){gui.showFeedback("Sorry, an error occured while communicating with the Enketo server.");
resetForm()}});$("#upload-form #input-switcher a").hover(function(){$(this).toggleClass("ui-state-hover")}).click(function(c){c.preventDefault();$("#upload-form label").hide().find('input[name="'+$(this).attr("id")+'"]').parents("label").show();$(this).siblings().removeClass("active");$(this).addClass("active")});$("#data-template-show input").change(function(){templateShow=$(this).is(":checked")?true:false;updateData()});$(document).on("click","#form-list a",function(c){var b=$(this).attr("id");
c.preventDefault();$('#upload-form input[name="form_id"]').val(b);$("#upload-form").submit()});$("#html5-form-source form").submit(function(){var c,b=$(this),d=b.attr("action"),b='<!DOCTYPE html><html><head><meta charset="utf-8" /><title></title></head><body>'+b.find('textarea[name="content"]').val()+"</body></html>",e=new FormData;e.append("level","error");e.append("content",b);$("#html5validationmessages div").html('<form style="text-align:center;"><progress></progress></form>');$.ajax(d,{type:"POST",
data:e,contentType:false,processData:false,success:function(b){var d=$("<div></div>");d.append(b.replace(/<script[A-z =".]*><\/script>/gi,""));d.find("ol:not(.source) li>*:first-child").each(function(){c=$(this).parent("li").attr("class");$(this).addClass(c)});parseMsgList(d.find("p.success, ol:not(.source) li>*:first-child"),$("#html5validationmessages div"));$("#html5validationmessages div li.info").hide()},error:function(){$("#html5validationmessages div").empty().append('<ol><li class="info"><span class="ui-icon ui-icon-info"></span>This validation is currently not functional</li></ol>')}});
return false});$("#upload-form #input-switcher a#server_url").click();$("#launch form").submit(function(c){c.preventDefault();console.debug("in ajax submit");gui.alert('<form style="text-align:center;><progress></progress></form>',"Requesting url...","normal");$.ajax("launch/launchSurvey",{type:"POST",data:$(this).serialize(),error:function(){gui.alert("Ouch, an error occurred during the request. Please try again.")},success:function(b){b=JSON.parse(b);console.log("form submission complete");if(b.success)gui.alert('Form was succesfully launched at this address: <a class="launch-link" href="'+
b.url+'">'+b.url+"</a>","Launched!","success");else switch(b.reason){case "existing":gui.alert('This survey was launched before at this address: <a class="launch-link" href="'+b.url+'">'+b.url+"</a>","Launched!","success");break;case "empty":gui.alert("Server url and/or form id submitted to the server found to be empty.","Failed");break;case "database":gui.alert("Problem occurred trying to add survey details to Enketo database to launch.","Failed");break;default:gui.alert("Unknown error","Failed")}}})});
state.server&&($('#upload-form input[name="server_url"]').val(state.server),state.id&&$('#upload-form input[name="form_id"]').val(state.id),$("#upload-form").submit())});function State(){}
State.prototype.init=function(){var c=!0,b=decodeURIComponent(decodeURI(getGetVariable("server")));this.server=b&&isValidUrl(b)?b:null;this.id=getGetVariable("id")||null;this.source=getGetVariable("source")||!1;this.debug=getGetVariable("debug")||!1;state.setUrl();$(window).on("popstate",function(){c||(window.location=location.href);c=!1});setTimeout(function(){c=!1},5E3)};
State.prototype.setUrl=function(){var c={server:this.server,id:this.id,source:this.source,debug:this.debug},b="",d="launch",b=null!==this.server&&isValidUrl(this.server)?b+"server="+encodeURIComponent(this.server):b,b=null!==this.id?b+"&id="+encodeURIComponent(this.id):b,b="true"==this.source||!0===this.source?b+"&source="+encodeURIComponent(this.source):b,b="true"==this.debug||!0===this.debug?b+"&debug="+encodeURIComponent(this.debug):b,b="&"==b.substring(0,1)?b.substring(1):b,d=0<b.length?d+"?"+
b:d;location.href!==location.protocol+"//"+location.hostname+"/"+d&&(console.debug("pushing history state "),console.debug(location.href),console.debug(location.hostname+"/"+d),console.debug(c),history.pushState(c,"Enketo Launch",d))};
State.prototype.setIdFromUrl=function(c){var b;isValidUrl(c)||(this.id=null);(b=c.match(/formhub\.org\/[A-z\_0-9\-]*\/forms\/([A-z\_0-9\-]*)\/form\.xml/i))||(b=c.match(/formXml\?formId=([A-z\_0-9\-]*)/i));return b?this.id=b[1]:console.error("could not extract id from url: "+c)};State.prototype.reset=function(){console.debug("resetting state");this.id=this.server=null;this.setUrl()};
GUI.prototype.setCustomEventHandlers=function(){$(document).on("click","button#validate-form:not(.disabled)",function(){"undefined"!==typeof form&&form.validateForm()});$(document).on("click","button#launch-form:not(.disabled)",function(){var c,b;state.server||(b="Requires a server url and ");state.id||(b=(b?b:"Requires ")+"a form to be selected first.");c=$('#launch [name="data_url"]').val();0<c.length&&!isValidUrl(c)&&(b=(b?b+"<br/>":"")+"The publication link is not a valid url");b&&0<b.length?
$("#launch p.alert.alert-error").html(b).show():($('#launch [name="server_url"]').val(state.server),$('#launch [name="form_id"]').val(state.id),$("#launch p.alert.alert-error").empty().hide(),$("#launch form").submit())});$("#launch a.advanced").click(function(c){c.preventDefault();$(this).hasClass("active")?$(this).text("show advanced options").removeClass("active").siblings("fieldset.advanced").hide():$(this).text("hide advanced options").addClass("active").siblings("fieldset.advanced").show()})};
function isValidUrl(c){return/^(https?:\/\/)?([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?[\/\w \.\-\=\&\?]*$/.test(c)}
function resetForm(){state.reset();$('#upload-form input[type="hidden"]').val("");$("#form-list ul").empty().hide();$("#upload-form progress").hide();$("#input-switcher, #upload .hurry").show().find("a#server_url").click();$("#form-languages").remove();$("#survey-form form, #xsltmessages div, #html5validationmessages div, #jrvalidationmessages div, #xmlerrors div, #xslerrors div, #html5-form-source textarea, #data textarea").empty();form=null;$("#validate-form").addClass("disabled");$('.nav li a[href="#upload"]').tab("show")}
function processResponse(c){c=$(c);0<c.find("formlist").length?processFormlist(c):processForm(c)}
function processForm(c){var b=(new XMLSerializer).serializeToString(c.find("form")[0]),d=(new XMLSerializer).serializeToString(c.find("instance")[0]),e=c.find("xsltmessages message"),g=c.find("jrvalidationmessages message"),h=c.find("xmlerrors message"),c=c.find("xslformerrors message, xsldataerrors message");$("#upload-form progress").hide();0<b.length?($("#html5-form-source textarea").empty().text(vkbeautify.xml(b)),$("#html5-form-source form").submit(),$("#survey-form form").replaceWith(b),form=
new Form("form.jr:eq(0)",d),form.init(),$('.nav a[href="#survey-form"]').tab("show"),$(document).on("change dataupdate","form.jr",updateData),$("#validate-form").removeClass("disabled")):($("#survey-form div").empty(),$('.nav li a[href="#report"]').tab("show"));form&&0<form.getDataStr().length?updateData():$("#data div").text("An error occurred whilst trying to extract the data.");form&&(0<form.getDataStr().length&&0===e.length)&&(e=$('<message class="success">Nothing reported back. A good sign if there are no other errors!</message>'));
parseMsgList(e,$("#xsltmessages div"));0===g.length&&(g=$('<message class="info">Something went wrong</message>'));parseMsgList(g,$("#jrvalidationmessages div"));0===h.length&&(h=$('<message class="success">Valid XML document!</message>'));parseMsgList(h,$("#xmlerrors div"));0<c.length&&c.each(function(){console.error("XSLT stylesheet error: "+$(this).text())});form&&(0<form.getDataStr().length&&0<$("#report .level-2, #report .level-3").length)&&gui.showFeedback(error_msg)}
function processFormlist(c){var b="";if(0===c.find("formlist>li").length)return gui.showFeedback("Formlist at server "+state.server+" was found to be empty or the server is asleep."),resetForm();c.find("formlist>li").each(function(){b+=(new XMLSerializer).serializeToString($(this)[0])});$("#form-list ul").empty().append(b);$("#form-list ul li a").addClass("btn btn-block");$("#upload-form progress").hide();$("#form-list").show()}
function updateData(){if(form){var c=form.getDataStr(templateShow);$("#data textarea").empty().text(vkbeautify.xml(c))}}
function parseMsgList(c,b){var d=$("<ul></ul>");c.each(function(){var b="",c=$(this).text(),h={"0":"info","info warning":"warning",1:"warning",2:"error",3:"error"},b=$(this).attr("level")?$(this).attr("level"):$(this).attr("class"),b='<li class="'+(h[b]?"text-"+h[b]:"muted")+'">'+c+"</li>";0===d.find("li").filter(function(){return $(this).text()==c}).length&&d.append(b)});b.empty().append(d)}
function addJsError(c){1!==$("#jserrors div ul").length&&$("#jserrors div").append("<ul></ul>");$("#jserrors div ul").append('<li class="text-error">'+c+"</li>")};